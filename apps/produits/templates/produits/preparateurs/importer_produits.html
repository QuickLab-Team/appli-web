{% extends 'preparateurs/base.html' %}
{% load static %}
{% block styles %}
    <link rel="stylesheet" href="{% static 'css/preparateurs/importer.css' %}">
{% endblock %}

{% block content %}
<h1>Importer des produits</h1>
<form method="post" enctype="multipart/form-data" class="import-form">
    {% csrf_token %}
    <label for="file_input" class="bouton">Choisir un fichier</label>
    <input type="file" id="file_input" name="fichier" accept=".csv, .xlsx" onchange="updateFileName()">
    <span id="file_name">Aucun fichier sélectionné</span>
    <button type="submit" class="bouton">Prévisualiser</button>
</form>

{% if produits_preview %}

    
    <h2>Prévisualisation des produits</h2>
    <p><strong>Total des produits trouvés :</strong> {{ produits_preview|length }}</p>

    <form method="post" id="import-form" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="importer" value="true">
        <label for="service">Service:</label>
        <select name="service" id="service" required>
            {% for service in services %}
                <option value="{{ service.nom }}">{{ service.nom }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="bouton">Importer dans la base de données</button>
    </form>
    <button type="button" class="bouton" onclick="openServicePopup()">Ajouter un service</button>

    <div id="servicePopup" class="popup" style="display:none;">
        <div class="popup-content">
            <span class="close" onclick="closeServicePopup()">&times;</span>
            <h2>Ajouter un nouveau service</h2>
            <form method="post" id="add-service-form">
                {% csrf_token %}
                <label for="new_service_name">Nom du service:</label>
                <input type="text" id="new_service_name" name="new_service_name" required>
                <button type="submit" class="bouton">Ajouter</button>
            </form>
        </div>
    </div>

    <script>
        function openServicePopup() {
            document.getElementById('servicePopup').style.display = 'block';
        }

        function closeServicePopup() {
            document.getElementById('servicePopup').style.display = 'none';
        }

        document.getElementById('add-service-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const newServiceName = document.getElementById('new_service_name').value;
            
            fetch("{% url 'produits:add_service' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ name: newServiceName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const serviceSelect = document.getElementById('service');
                    const newOption = document.createElement('option');
                    newOption.value = newServiceName;
                    newOption.textContent = newServiceName;
                    serviceSelect.appendChild(newOption);
                    closeServicePopup();
                } else {
                    alert('Erreur lors de l\'ajout du service');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="importer" value="true">
        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Quantité</th>
                    <th>Unité</th>
                    <th>Fournisseur</th>
                    <th>Famille</th>
                    <th>Stockage</th>
                </tr>
            </thead>
            <tbody>
                {% for produit in produits_preview %}
                <tr>
                    <td>{{ produit.nom }}</td>
                    <td>{{ produit.quantite }}</td>
                    <td>{{ produit.unite}}</td>
                    <td>{{ produit.fournisseur }}</td>
                    <td>{{ produit.famille }}</td>
                    <td>{{ produit.stockage }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
{% endif %}
<script>
    function updateFileName() {
        const fileInput = document.getElementById('file_input');
        const fileNameSpan = document.getElementById('file_name');
        fileNameSpan.textContent = fileInput.files[0].name;
    }
</script>
{% endblock %}
